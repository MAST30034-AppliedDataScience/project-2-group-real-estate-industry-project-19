import re
import os
import time
import random
import csv
from tqdm import tqdm
from collections import defaultdict
from urllib.request import urlopen, Request
from urllib.error import URLError, HTTPError
from bs4 import BeautifulSoup

# constants
BASE_URL = "https://www.domain.com.au"

#SUBURBS = ['ashburton-vic-3147', 'balwyn-north-vic-3104','balwyn-vic-3103', 'camberwell-vic-3124', 'glen-iris-vic-3146', 'hawthorn-east-vic-3123',
#           'kew-east-vic-3102', 'surrey-hills-vic-3127', 'hawthorn-vic-3122', 'kew-vic-3101', 'bulleen-vic-3105', 'doncaster-vic-3108',
#           'templestowe-vic-3106', 'templestowe-lower-vic-3107','doncaster-east-vic-3109','blackburn-vic-3130','blackburn-south-vic-3130','blackburn-north-vic-3130',
#           'box-hill-vic-3128','box-hill-south-vic-3128','box-hill-north-vic-3129','burwood-vic-3125','burwood-east-vic-3151','mont-albert-vic-3127']

SUBURBS = ['melbourne-vic-3000',
 'east-melbourne-vic-3002',
 'west-melbourne-vic-3003',
 'melbourne-vic-3004',
 'south-wharf-vic-3006',
 'southbank-vic-3006',
 'docklands-vic-3008',
 'university-of-melbourne-vic-3010',
 'footscray-vic-3011',
 'seddon-vic-3011',
 'seddon-west-vic-3011',
 'brooklyn-vic-3012',
 'kingsville-vic-3012',
 'maidstone-vic-3012',
 'tottenham-vic-3012',
 'west-footscray-vic-3012',
 'yarraville-vic-3013',
 'newport-vic-3015',
 'south-kingsville-vic-3015',
 'spotswood-vic-3015',
 'williamstown-vic-3016',
 'williamstown-north-vic-3016',
 'altona-vic-3018',
 'seaholme-vic-3018',
 'braybrook-vic-3019',
 'robinson-vic-3019',
 'albion-vic-3020',
 'sunshine-vic-3020',
 'sunshine-north-vic-3020',
 'sunshine-west-vic-3020',
 'albanvale-vic-3021',
 'kealba-vic-3021',
 'kings-park-vic-3021',
 'st-albans-vic-3021',
 'ardeer-vic-3022',
 'deer-park-east-vic-3022',
 'burnside-vic-3023',
 'burnside-heights-vic-3023',
 'cairnlea-vic-3023',
 'caroline-springs-vic-3023',
 'deer-park-vic-3023',
 'deer-park-north-vic-3023',
 'ravenhall-vic-3023',
 'mambourin-vic-3024',
 'mount-cottrell-vic-3024',
 'wyndham-vale-vic-3024',
 'altona-east-vic-3025',
 'altona-gate-vic-3025',
 'altona-north-vic-3025',
 'laverton-north-vic-3026',
 'williams-landing-vic-3027',
 'altona-meadows-vic-3028',
 'laverton-vic-3028',
 'seabrook-vic-3028',
 'hoppers-crossing-vic-3029',
 'tarneit-vic-3029',
 'truganina-vic-3029',
 'cocoroc-vic-3030',
 'derrimut-vic-3030',
 'point-cook-vic-3030',
 'quandong-vic-3030',
 'werribee-vic-3030',
 'werribee-south-vic-3030',
 'flemington-vic-3031',
 'kensington-vic-3031',
 'ascot-vale-vic-3032',
 'highpoint-city-vic-3032',
 'maribyrnong-vic-3032',
 'travancore-vic-3032',
 'keilor-east-vic-3033',
 'avondale-heights-vic-3034',
 'keilor-vic-3036',
 'keilor-north-vic-3036',
 'calder-park-vic-3037',
 'delahey-vic-3037',
 'hillside-vic-3037',
 'sydenham-vic-3037',
 'taylors-hill-vic-3037',
 'keilor-downs-vic-3038',
 'keilor-lodge-vic-3038',
 'taylors-lakes-vic-3038',
 'moonee-ponds-vic-3039',
 'aberfeldie-vic-3040',
 'essendon-vic-3040',
 'essendon-west-vic-3040',
 'essendon-fields-vic-3041',
 'essendon-north-vic-3041',
 'strathmore-vic-3041',
 'strathmore-heights-vic-3041',
 'airport-west-vic-3042',
 'keilor-park-vic-3042',
 'niddrie-vic-3042',
 'gladstone-park-vic-3043',
 'gowanbrae-vic-3043',
 'tullamarine-vic-3043',
 'pascoe-vale-vic-3044',
 'pascoe-vale-south-vic-3044',
 'melbourne-airport-vic-3045',
 'glenroy-vic-3046',
 'hadfield-vic-3046',
 'oak-park-vic-3046',
 'broadmeadows-vic-3047',
 'dallas-vic-3047',
 'jacana-vic-3047',
 'coolaroo-vic-3048',
 'meadow-heights-vic-3048',
 'attwood-vic-3049',
 'westmeadows-vic-3049',
 'royal-melbourne-hospital-vic-3050',
 'hotham-hill-vic-3051',
 'north-melbourne-vic-3051',
 'melbourne-university-vic-3052',
 'parkville-vic-3052',
 'carlton-vic-3053',
 'carlton-south-vic-3053',
 'carlton-north-vic-3054',
 'princes-hill-vic-3054',
 'brunswick-south-vic-3055',
 'brunswick-west-vic-3055',
 'moonee-vale-vic-3055',
 'moreland-west-vic-3055',
 'brunswick-vic-3056',
 'brunswick-lower-vic-3056',
 'brunswick-north-vic-3056',
 'brunswick-east-vic-3057',
 'sumner-vic-3057',
 'batman-vic-3058',
 'coburg-vic-3058',
 'coburg-north-vic-3058',
 'merlynston-vic-3058',
 'moreland-vic-3058',
 'greenvale-vic-3059',
 'fawkner-vic-3060',
 'campbellfield-vic-3061',
 'somerton-vic-3062',
 'oaklands-junction-vic-3063',
 'yuroke-vic-3063',
 'craigieburn-vic-3064',
 'donnybrook-vic-3064',
 'kalkallo-vic-3064',
 'mickleham-vic-3064',
 'roxburgh-park-vic-3064',
 'fitzroy-vic-3065',
 'collingwood-vic-3066',
 'collingwood-north-vic-3066',
 'abbotsford-vic-3067',
 'clifton-hill-vic-3068',
 'fitzroy-north-vic-3068',
 'northcote-vic-3070',
 'thornbury-vic-3071',
 'gilberton-vic-3072',
 'northland-centre-vic-3072',
 'preston-vic-3072',
 'preston-south-vic-3072',
 'preston-west-vic-3072',
 'regent-west-vic-3072',
 'reservoir-vic-3073',
 'thomastown-vic-3074',
 'lalor-vic-3075',
 'epping-vic-3076',
 'alphington-vic-3078',
 'fairfield-vic-3078',
 'ivanhoe-vic-3079',
 'ivanhoe-east-vic-3079',
 'ivanhoe-north-vic-3079',
 'bellfield-vic-3081',
 'heidelberg-heights-vic-3081',
 'heidelberg-west-vic-3081',
 'mill-park-vic-3082',
 'bundoora-vic-3083',
 'kingsbury-vic-3083',
 'la-trobe-university-vic-3083',
 'banyule-vic-3084',
 'eaglemont-vic-3084',
 'heidelberg-vic-3084',
 'rosanna-vic-3084',
 'viewbank-vic-3084',
 'macleod-vic-3085',
 'macleod-west-vic-3085',
 'yallambie-vic-3085',
 'watsonia-vic-3087',
 'watsonia-north-vic-3087',
 'briar-hill-vic-3088',
 'greensborough-vic-3088',
 'st-helena-vic-3088',
 'diamond-creek-vic-3089',
 'plenty-vic-3090',
 'yarrambat-vic-3091',
 'lower-plenty-vic-3093',
 'montmorency-vic-3094',
 'eltham-vic-3095',
 'eltham-north-vic-3095',
 'research-vic-3095',
 'wattle-glen-vic-3096',
 'bend-of-islands-vic-3097',
 'kangaroo-ground-vic-3097',
 'watsons-creek-vic-3097',
 'arthurs-creek-vic-3099',
 'cottles-bridge-vic-3099',
 'hurstbridge-vic-3099',
 'nutfield-vic-3099',
 'strathewen-vic-3099',
 'cotham-vic-3101',
 'kew-vic-3101',
 'kew-east-vic-3102',
 'balwyn-vic-3103',
 'balwyn-east-vic-3103',
 'deepdene-vic-3103',
 'balwyn-north-vic-3104',
 'greythorn-vic-3104',
 'bulleen-vic-3105',
 'templestowe-vic-3106',
 'templestowe-lower-vic-3107',
 'doncaster-vic-3108',
 'doncaster-east-vic-3109',
 'doncaster-heights-vic-3109',
 'donvale-vic-3111',
 'north-warrandyte-vic-3113',
 'warrandyte-vic-3113',
 'park-orchards-vic-3114',
 'wonga-park-vic-3115',
 'chirnside-park-vic-3116',
 'burnley-vic-3121',
 'burnley-north-vic-3121',
 'cremorne-vic-3121',
 'richmond-vic-3121',
 'richmond-east-vic-3121',
 'richmond-north-vic-3121',
 'richmond-south-vic-3121',
 'auburn-south-vic-3122',
 'glenferrie-south-vic-3122',
 'hawthorn-vic-3122',
 'hawthorn-north-vic-3122',
 'hawthorn-west-vic-3122',
 'auburn-vic-3123',
 'hawthorn-east-vic-3123',
 'camberwell-vic-3124',
 'camberwell-north-vic-3124',
 'camberwell-south-vic-3124',
 'camberwell-west-vic-3124',
 'hartwell-vic-3124',
 'middle-camberwell-vic-3124',
 'burwood-vic-3125',
 'camberwell-east-vic-3126',
 'canterbury-vic-3126',
 'mont-albert-vic-3127',
 'surrey-hills-vic-3127',
 'surrey-hills-north-vic-3127',
 'box-hill-vic-3128',
 'box-hill-south-vic-3128',
 'wattle-park-vic-3128',
 'box-hill-north-vic-3129',
 'kerrimuir-vic-3129',
 'mont-albert-north-vic-3129',
 'blackburn-vic-3130',
 'blackburn-north-vic-3130',
 'blackburn-south-vic-3130',
 'laburnum-vic-3130',
 'brentford-square-vic-3131',
 'forest-hill-vic-3131',
 'nunawading-vic-3131',
 'mitcham-vic-3132',
 'mitcham-north-vic-3132',
 'rangeview-vic-3132',
 'vermont-vic-3133',
 'vermont-south-vic-3133',
 'heathwood-vic-3134',
 'ringwood-vic-3134',
 'ringwood-north-vic-3134',
 'warrandyte-south-vic-3134',
 'warranwood-vic-3134',
 'bedford-road-vic-3135',
 'heathmont-vic-3135',
 'ringwood-east-vic-3135',
 'croydon-vic-3136',
 'croydon-hills-vic-3136',
 'croydon-north-vic-3136',
 'croydon-south-vic-3136',
 'kilsyth-vic-3137',
 'kilsyth-south-vic-3137',
 'mooroolbark-vic-3138',
 'beenak-vic-3139',
 'don-valley-vic-3139',
 'hoddles-creek-vic-3139',
 'launching-place-vic-3139',
 'seville-vic-3139',
 'seville-east-vic-3139',
 'wandin-east-vic-3139',
 'wandin-north-vic-3139',
 'woori-yallock-vic-3139',
 'yellingbo-vic-3139',
 'lilydale-vic-3140',
 'south-yarra-vic-3141',
 'hawksburn-vic-3142',
 'toorak-vic-3142',
 'armadale-vic-3143',
 'armadale-north-vic-3143',
 'kooyong-vic-3144',
 'malvern-vic-3144',
 'caulfield-east-vic-3145',
 'central-park-vic-3145',
 'darling-vic-3145',
 'malvern-east-vic-3145',
 'wattletree-road-po-vic-3145',
 'glen-iris-vic-3146',
 'ashburton-vic-3147',
 'ashwood-vic-3147',
 'chadstone-vic-3148',
 'chadstone-centre-vic-3148',
 'holmesglen-vic-3148',
 'mount-waverley-vic-3149',
 'pinewood-vic-3149',
 'syndal-vic-3149',
 'brandon-park-vic-3150',
 'glen-waverley-vic-3150',
 'wheelers-hill-vic-3150',
 'burwood-east-vic-3151',
 'burwood-heights-vic-3151',
 'knox-city-centre-vic-3152',
 'studfield-vic-3152',
 'wantirna-vic-3152',
 'wantirna-south-vic-3152',
 'bayswater-vic-3153',
 'bayswater-north-vic-3153',
 'the-basin-vic-3154',
 'boronia-vic-3155',
 'ferntree-gully-vic-3156',
 'lysterfield-vic-3156',
 'lysterfield-south-vic-3156',
 'mountain-gate-vic-3156',
 'upper-ferntree-gully-vic-3156',
 'upwey-vic-3158',
 'menzies-creek-vic-3159',
 'selby-vic-3159',
 'belgrave-vic-3160',
 'belgrave-heights-vic-3160',
 'belgrave-south-vic-3160',
 'tecoma-vic-3160',
 'caulfield-junction-vic-3161',
 'caulfield-north-vic-3161',
 'caulfield-vic-3162',
 'caulfield-south-vic-3162',
 'hopetoun-gardens-vic-3162',
 'carnegie-vic-3163',
 'glen-huntly-vic-3163',
 'murrumbeena-vic-3163',
 'dandenong-south-vic-3164',
 'bentleigh-east-vic-3165',
 'hughesdale-vic-3166',
 'huntingdale-vic-3166',
 'oakleigh-vic-3166',
 'oakleigh-east-vic-3166',
 'oakleigh-south-vic-3167',
 'clayton-vic-3168',
 'notting-hill-vic-3168',
 'clarinda-vic-3169',
 'clayton-south-vic-3169',
 'mulgrave-vic-3170',
 'waverley-gardens-vic-3170',
 'sandown-village-vic-3171',
 'springvale-vic-3171',
 'dingley-village-vic-3172',
 'springvale-south-vic-3172',
 'keysborough-vic-3173',
 'noble-park-vic-3174',
 'noble-park-north-vic-3174',
 'bangholme-vic-3175',
 'dandenong-vic-3175',
 'dandenong-east-vic-3175',
 'dandenong-north-vic-3175',
 'dandenong-south-vic-3175',
 'dunearn-vic-3175',
 'scoresby-bc-vic-3176',
 'doveton-vic-3177',
 'eumemmerring-vic-3177',
 'rowville-vic-3178',
 'scoresby-vic-3179',
 'knoxfield-vic-3180',
 'prahran-vic-3181',
 'prahran-east-vic-3181',
 'windsor-vic-3181',
 'st-kilda-vic-3182',
 'st-kilda-south-vic-3182',
 'st-kilda-west-vic-3182',
 'balaclava-vic-3183',
 'st-kilda-east-vic-3183',
 'brighton-road-vic-3184',
 'elwood-vic-3184',
 'elsternwick-vic-3185',
 'gardenvale-vic-3185',
 'ripponlea-vic-3185',
 'brighton-vic-3186',
 'brighton-north-vic-3186',
 'dendy-vic-3186',
 'were-street-po-vic-3186',
 'brighton-east-vic-3187',
 'north-road-vic-3187',
 'hampton-vic-3188',
 'hampton-east-vic-3188',
 'hampton-north-vic-3188',
 'moorabbin-vic-3189',
 'moorabbin-east-vic-3189',
 'wishart-vic-3189',
 'highett-vic-3190',
 'sandringham-vic-3191',
 'cheltenham-vic-3192',
 'cheltenham-east-vic-3192',
 'southland-centre-vic-3192',
 'beaumaris-vic-3193',
 'black-rock-vic-3193',
 'black-rock-north-vic-3193',
 'cromer-vic-3193',
 'mentone-vic-3194',
 'mentone-east-vic-3194',
 'moorabbin-airport-vic-3194',
 'aspendale-vic-3195',
 'aspendale-gardens-vic-3195',
 'braeside-vic-3195',
 'mordialloc-vic-3195',
 'parkdale-vic-3195',
 'waterways-vic-3195',
 'bonbeach-vic-3196',
 'chelsea-vic-3196',
 'chelsea-heights-vic-3196',
 'edithvale-vic-3196',
 'carrum-vic-3197',
 'patterson-lakes-vic-3197',
 'seaford-vic-3198',
 'frankston-vic-3199',
 'frankston-east-vic-3199',
 'frankston-heights-vic-3199',
 'frankston-south-vic-3199',
 'karingal-centre-vic-3199',
 'frankston-north-vic-3200',
 'pines-forest-vic-3200',
 'carrum-downs-vic-3201',
 'heatherton-vic-3202',
 'bentleigh-vic-3204',
 'mckinnon-vic-3204',
 'ormond-vic-3204',
 'patterson-vic-3204',
 'south-melbourne-vic-3205',
 'albert-park-vic-3206',
 'middle-park-vic-3206',
 'garden-city-vic-3207',
 'port-melbourne-vic-3207',
 'little-river-vic-3211',
 'avalon-vic-3212',
 'lara-vic-3212',
 'point-wilson-vic-3212',
 'anakie-vic-3213',
 'batesford-vic-3213',
 'lovely-banks-vic-3213',
 'moorabool-vic-3213',
 'corio-vic-3214',
 'norlane-vic-3214',
 'north-shore-vic-3214',
 'bell-park-vic-3215',
 'bell-post-hill-vic-3215',
 'drumcondra-vic-3215',
 'geelong-north-vic-3215',
 'hamlyn-heights-vic-3215',
 'north-geelong-vic-3215',
 'rippleside-vic-3215',
 'belmont-vic-3216',
 'grovedale-vic-3216',
 'grovedale-east-vic-3216',
 'highton-vic-3216',
 'marshall-vic-3216',
 'wandana-heights-vic-3216',
 'waurn-ponds-vic-3216',
 'armstrong-creek-vic-3217',
 'charlemont-vic-3217',
 'freshwater-creek-vic-3217',
 'mount-duneed-vic-3217',
 'fyansford-vic-3218',
 'geelong-west-vic-3218',
 'herne-hill-vic-3218',
 'manifold-heights-vic-3218',
 'murgheboluc-vic-3218',
 'stonehaven-vic-3218',
 'breakwater-vic-3219',
 'east-geelong-vic-3219',
 'newcomb-vic-3219',
 'st-albans-park-vic-3219',
 'thomson-vic-3219',
 'whittington-vic-3219',
 'bareena-vic-3220',
 'geelong-vic-3220',
 'newtown-vic-3220',
 'south-geelong-vic-3220',
 'barrabool-vic-3221',
 'ceres-vic-3221',
 'gnarwarre-vic-3221',
 'clifton-springs-vic-3222',
 'curlewis-vic-3222',
 'drysdale-vic-3222',
 'mannerim-vic-3222',
 'marcus-hill-vic-3222',
 'wallington-vic-3222',
 'bellarine-vic-3223',
 'indented-head-vic-3223',
 'portarlington-vic-3223',
 'st-leonards-vic-3223',
 'leopold-vic-3224',
 'moolap-vic-3224',
 'point-lonsdale-vic-3225',
 'queenscliff-vic-3225',
 'swan-bay-vic-3225',
 'swan-island-vic-3225',
 'ocean-grove-vic-3226',
 'barwon-heads-vic-3227',
 'breamlea-vic-3227',
 'connewarre-vic-3227',
 'bellbrae-vic-3228',
 'bells-beach-vic-3228',
 'jan-juc-vic-3228',
 'torquay-vic-3228',
 'anglesea-vic-3230',
 'aireys-inlet-vic-3231',
 'big-hill-vic-3231',
 'eastern-view-vic-3231',
 'fairhaven-vic-3231',
 'moggs-creek-vic-3231',
 'lorne-vic-3232',
 'apollo-bay-vic-3233',
 'cape-otway-vic-3233',
 'marengo-vic-3233',
 'petticoat-creek-vic-3233',
 'skenes-creek-vic-3233',
 'skenes-creek-north-vic-3233',
 'grey-river-vic-3234',
 'kennett-river-vic-3234',
 'separation-creek-vic-3234',
 'sugarloaf-vic-3234',
 'wongarra-vic-3234',
 'wye-river-vic-3234',
 'benwerrin-vic-3235',
 'boonah-vic-3235',
 'deans-marsh-vic-3235',
 'pennyroyal-vic-3235',
 'forrest-vic-3236',
 'mount-sabine-vic-3236',
 'aire-valley-vic-3237',
 'beech-forest-vic-3237',
 'ferguson-vic-3237',
 'gellibrand-lower-vic-3237',
 'wattle-hill-vic-3237',
 'weeaproinah-vic-3237',
 'wyelangta-vic-3237',
 'yuulong-vic-3237',
 'glenaire-vic-3238',
 'hordern-vale-vic-3238',
 'johanna-vic-3238',
 'lavers-hill-vic-3238',
 'carlisle-river-vic-3239',
 'chapple-vale-vic-3239',
 'gellibrand-vic-3239',
 'kennedys-creek-vic-3239',
 'buckley-vic-3240',
 'gherang-vic-3240',
 'modewarre-vic-3240',
 'moriac-vic-3240',
 'mount-moriac-vic-3240',
 'paraparap-vic-3240',
 'bambra-vic-3241',
 'ombersley-vic-3241',
 'wensleydale-vic-3241',
 'winchelsea-vic-3241',
 'winchelsea-south-vic-3241',
 'wurdiboluc-vic-3241',
 'birregurra-vic-3242',
 'barwon-downs-vic-3243',
 'murroon-vic-3243',
 'warncoort-vic-3243',
 'whoorel-vic-3243',
 'alvie-vic-3249',
 'balintore-vic-3249',
 'barongarook-vic-3249',
 'barongarook-west-vic-3249',
 'barramunga-vic-3249',
 'coragulac-vic-3249',
 'corunnun-vic-3249',
 'dreeite-vic-3249',
 'dreeite-south-vic-3249',
 'gerangamete-vic-3249',
 'irrewarra-vic-3249',
 'irrewillipe-vic-3249',
 'irrewillipe-east-vic-3249',
 'kawarren-vic-3249',
 'larpent-vic-3249',
 'nalangil-vic-3249',
 'ondit-vic-3249',
 'pirron-yallock-vic-3249',
 'pomborneit-east-vic-3249',
 'swan-marsh-vic-3249',
 'tanybryn-vic-3249',
 'warrion-vic-3249',
 'wool-wool-vic-3249',
 'yeo-vic-3249',
 'yeodene-vic-3249',
 'colac-vic-3250',
 'colac-east-vic-3250',
 'colac-west-vic-3250',
 'elliminyt-vic-3250',
 'beeac-vic-3251',
 'cundare-vic-3251',
 'cundare-north-vic-3251',
 'eurack-vic-3251',
 'weering-vic-3251',
 'cororooke-vic-3254',
 'bookaar-vic-3260',
 'bostocks-creek-vic-3260',
 'bungador-vic-3260',
 'camperdown-vic-3260',
 'carpendeit-vic-3260',
 'chocolyn-vic-3260',
 'gnotuk-vic-3260',
 'kariah-vic-3260',
 'koallah-vic-3260',
 'leslie-manor-vic-3260',
 'pomborneit-vic-3260',
 'pomborneit-north-vic-3260',
 'skibo-vic-3260',
 'south-purrumbete-vic-3260',
 'stonyford-vic-3260',
 'tandarook-vic-3260',
 'tesbury-vic-3260',
 'weerite-vic-3260',
 'terang-vic-3264',
 'boorcan-vic-3265',
 'cudgee-vic-3265',
 'dixie-vic-3265',
 'ecklin-south-vic-3265',
 'ellerslie-vic-3265',
 'framlingham-vic-3265',
 'framlingham-east-vic-3265',
 'garvoc-vic-3265',
 'glenormiston-north-vic-3265',
 'glenormiston-south-vic-3265',
 'kolora-vic-3265',
 'laang-vic-3265',
 'noorat-vic-3265',
 'noorat-east-vic-3265',
 'panmure-vic-3265',
 'taroon-vic-3265',
 'the-sisters-vic-3265',
 'bullaharre-vic-3266',
 'cobden-vic-3266',
 'cobrico-vic-3266',
 'elingamite-vic-3266',
 'elingamite-north-vic-3266',
 'glenfyne-vic-3266',
 'jancourt-vic-3266',
 'jancourt-east-vic-3266',
 'naroghid-vic-3266',
 'simpson-vic-3266',
 'scotts-creek-vic-3267',
 'ayrford-vic-3268',
 'brucknell-vic-3268',
 'cooriemungle-vic-3268',
 'cowleys-creek-vic-3268',
 'curdies-river-vic-3268',
 'curdievale-vic-3268',
 'heytesbury-lower-vic-3268',
 'newfield-vic-3268',
 'nirranda-vic-3268',
 'nirranda-east-vic-3268',
 'nirranda-south-vic-3268',
 'nullawarre-vic-3268',
 'nullawarre-north-vic-3268',
 'paaratte-vic-3268',
 'the-cove-vic-3268',
 'timboon-vic-3268',
 'timboon-west-vic-3268',
 'port-campbell-vic-3269',
 'princetown-vic-3269',
 'waarre-vic-3269',
 'peterborough-vic-3270',
 'darlington-vic-3271',
 'dundonnell-vic-3271',
 'pura-pura-vic-3271',
 'mortlake-vic-3272',
 'woorndoo-vic-3272',
 'hexham-vic-3273',
 'caramut-vic-3274',
 'mailors-flat-vic-3275',
 'minjah-vic-3276',
 'woolsthorpe-vic-3276',
 'allansford-vic-3277',
 'mepunga-vic-3277',
 'mepunga-east-vic-3277',
 'mepunga-west-vic-3277',
 'naringal-vic-3277',
 'naringal-east-vic-3277',
 'purnim-vic-3278',
 'purnim-west-vic-3278',
 'ballangeich-vic-3279',
 'wangoom-vic-3279',
 'dennington-vic-3280',
 'warrnambool-vic-3280',
 'bushfield-vic-3281',
 'grassmere-vic-3281',
 'winslow-vic-3281',
 'woodford-vic-3281',
 'illowa-vic-3282',
 'koroit-vic-3282',
 'crossley-vic-3283',
 'killarney-vic-3283',
 'kirkstall-vic-3283',
 'southern-cross-vic-3283',
 'tarrone-vic-3283',
 'tower-hill-vic-3283',
 'warrong-vic-3283',
 'willatook-vic-3283',
 'yangery-vic-3283',
 'yarpturk-vic-3283',
 'orford-vic-3284',
 'port-fairy-vic-3284',
 'codrington-vic-3285',
 'narrawong-vic-3285',
 'rosebrook-vic-3285',
 'st-helens-vic-3285',
 'toolong-vic-3285',
 'tyrendarra-vic-3285',
 'tyrendarra-east-vic-3285',
 'yambuk-vic-3285',
 'condah-swamp-vic-3286',
 'knebsworth-vic-3286',
 'macarthur-vic-3286',
 'warrabkook-vic-3286',
 'hawkesdale-vic-3287',
 'minhamite-vic-3287',
 'gazette-vic-3289',
 'gerrigerrup-vic-3289',
 'penshurst-vic-3289',
 'purdeet-vic-3289',
 'tabor-vic-3289',
 'nelson-vic-3292',
 'glenthompson-vic-3293',
 'nareeb-vic-3293',
 'narrapumelap-south-vic-3293',
 'dunkeld-vic-3294',
 'karabeal-vic-3294',
 'mirranatwa-vic-3294',
 'moutajup-vic-3294',
 'victoria-point-vic-3294',
 'victoria-valley-vic-3294',
 'woodhouse-vic-3294',
 'byaduk-north-vic-3300',
 'hamilton-vic-3300',
 'bochara-vic-3301',
 'broadwater-vic-3301',
 'buckley-swamp-vic-3301',
 'byaduk-vic-3301',
 'croxton-east-vic-3301',
 'hensley-park-vic-3301',
 'morgiana-vic-3301',
 'mount-napier-vic-3301',
 'strathkellar-vic-3301',
 'tahara-vic-3301',
 'tarrington-vic-3301',
 'wannon-vic-3301',
 'warrayure-vic-3301',
 'yatchaw-vic-3301',
 'yulecart-vic-3301',
 'branxholme-vic-3302',
 'grassdale-vic-3302',
 'breakaway-creek-vic-3303',
 'condah-vic-3303',
 'hotspur-vic-3303',
 'lake-condah-vic-3303',
 'wallacedale-vic-3303',
 'bessiebelle-vic-3304',
 'dartmoor-vic-3304',
 'drik-drik-vic-3304',
 'drumborg-vic-3304',
 'greenwald-vic-3304',
 'heywood-vic-3304',
 'homerton-vic-3304',
 'lyons-vic-3304',
 'milltown-vic-3304',
 'mumbannar-vic-3304',
 'myamyn-vic-3304',
 'winnap-vic-3304',
 'allestree-vic-3305',
 'bolwarra-vic-3305',
 'cape-bridgewater-vic-3305',
 'cashmore-vic-3305',
 'dutton-way-vic-3305',
 'gorae-vic-3305',
 'gorae-west-vic-3305',
 'heathmere-vic-3305',
 'mount-richmond-vic-3305',
 'portland-vic-3305',
 'portland-north-vic-3305',
 'portland-west-vic-3305',
 'digby-vic-3309',
 'merino-vic-3310',
 'tahara-west-vic-3310',
 'casterton-vic-3311',
 'corndale-vic-3311',
 'bahgallah-vic-3312',
 'brimboal-vic-3312',
 'carapook-vic-3312',
 'chetwynd-vic-3312',
 'dergholm-vic-3312',
 'dorodong-vic-3312',
 'dunrobin-vic-3312',
 'henty-vic-3312',
 'killara-vic-3312',
 'lake-mundi-vic-3312',
 'lindsay-vic-3312',
 'nangeela-vic-3312',
 'poolaijelo-vic-3312',
 'powers-creek-vic-3312',
 'sandford-vic-3312',
 'strathdownie-vic-3312',
 'wando-bridge-vic-3312',
 'wando-vale-vic-3312',
 'warrock-vic-3312',
 'bulart-vic-3314',
 'cavendish-vic-3314',
 'glenisla-vic-3314',
 'grampians-vic-3314',
 'mooralla-vic-3314',
 'brit-brit-vic-3315',
 'clover-flat-vic-3315',
 'coleraine-vic-3315',
 'coojar-vic-3315',
 'culla-vic-3315',
 'gringegalgona-vic-3315',
 'gritjurk-vic-3315',
 'hilgay-vic-3315',
 'konongwootong-vic-3315',
 'melville-forest-vic-3315',
 'muntham-vic-3315',
 'nareen-vic-3315',
 'paschendale-vic-3315',
 'tahara-bridge-vic-3315',
 'tarrayoukyan-vic-3315',
 'tarrenlea-vic-3315',
 'wootong-vale-vic-3315',
 'harrow-vic-3317',
 'charam-vic-3318',
 'connewirricoo-vic-3318',
 'edenhope-vic-3318',
 'kadnook-vic-3318',
 'langkoop-vic-3318',
 'patyah-vic-3318',
 'ullswater-vic-3318',
 'apsley-vic-3319',
 'benayeo-vic-3319',
 'bringalbert-vic-3319',
 'hesse-vic-3321',
 'inverleigh-vic-3321',
 'wingeel-vic-3321',
 'cressy-vic-3322',
 'berrybank-vic-3323',
 'duverney-vic-3323',
 'foxhow-vic-3323',
 'lismore-vic-3324',
 'mingay-vic-3324',
 'mount-bute-vic-3324',
 'derrinallum-vic-3325',
 'larralea-vic-3325',
 'vite-vite-vic-3325',
 'vite-vite-north-vic-3325',
 'teesdale-vic-3328',
 'barunah-park-vic-3329',
 'barunah-plains-vic-3329',
 'shelford-vic-3329',
 'rokewood-vic-3330',
 'bannockburn-vic-3331',
 'gheringhap-vic-3331',
 'maude-vic-3331',
 'russells-bridge-vic-3331',
 'she-oaks-vic-3331',
 'steiglitz-vic-3331',
 'sutherlands-creek-vic-3331',
 'lethbridge-vic-3332',
 'bamganie-vic-3333',
 'meredith-vic-3333',
 'bungal-vic-3334',
 'cargerie-vic-3334',
 'elaine-vic-3334',
 'morrisons-vic-3334',
 'mount-doran-vic-3334',
 'plumpton-vic-3335',
 'rockbank-vic-3335',
 'kurunjang-vic-3337',
 'melton-vic-3337',
 'melton-west-vic-3337',
 'toolern-vale-vic-3337',
 'brookfield-vic-3338',
 'exford-vic-3338',
 'eynesbury-vic-3338',
 'melton-south-vic-3338',
 'bacchus-marsh-vic-3340',
 'balliang-vic-3340',
 'balliang-east-vic-3340',
 'coimadai-vic-3340',
 'darley-vic-3340',
 'glenmore-vic-3340',
 'hopetoun-park-vic-3340',
 'long-forest-vic-3340',
 'maddingley-vic-3340',
 'merrimu-vic-3340',
 'parwan-vic-3340',
 'rowsley-vic-3340',
 'staughton-vale-vic-3340',
 'dales-creek-vic-3341',
 'greendale-vic-3341',
 'korobeit-vic-3341',
 'myrniong-vic-3341',
 'pentland-hills-vic-3341',
 'ballan-vic-3342',
 'beremboke-vic-3342',
 'blakeville-vic-3342',
 'bunding-vic-3342',
 'colbrook-vic-3342',
 'durdidwarrah-vic-3342',
 'fiskville-vic-3342',
 'ingliston-vic-3342',
 'mount-wallace-vic-3342',
 'gordon-vic-3345',
 'alfredton-vic-3350',
 'bakery-hill-vic-3350',
 'ballarat-vic-3350',
 'ballarat-central-vic-3350',
 'ballarat-east-vic-3350',
 'ballarat-north-vic-3350',
 'ballarat-west-vic-3350',
 'black-hill-vic-3350',
 'brown-hill-vic-3350',
 'canadian-vic-3350',
 'eureka-vic-3350',
 'golden-point-vic-3350',
 'invermay-park-vic-3350',
 'lake-wendouree-vic-3350',
 'lucas-vic-3350',
 'mount-clear-vic-3350',
 'mount-helen-vic-3350',
 'mount-pleasant-vic-3350',
 'nerrina-vic-3350',
 'newington-vic-3350',
 'redan-vic-3350',
 'soldiers-hill-vic-3350',
 'berringa-vic-3351',
 'bo-peep-vic-3351',
 'cape-clear-vic-3351',
 'carngham-vic-3351',
 'chepstowe-vic-3351',
 'haddon-vic-3351',
 'hillcrest-vic-3351',
 'illabarook-vic-3351',
 'lake-bolac-vic-3351',
 'mininera-vic-3351',
 'mount-emu-vic-3351',
 'nerrin-nerrin-vic-3351',
 'newtown-vic-3351',
 'nintingbool-vic-3351',
 'piggoreet-vic-3351',
 'pitfield-vic-3351',
 'rokewood-junction-vic-3351',
 'ross-creek-vic-3351',
 'scarsdale-vic-3351',
 'smythes-creek-vic-3351',
 'smythesdale-vic-3351',
 'snake-valley-vic-3351',
 'springdallah-vic-3351',
 'staffordshire-reef-vic-3351',
 'streatham-vic-3351',
 'wallinduc-vic-3351',
 'westmere-vic-3351',
 'addington-vic-3352',
 'blowhard-vic-3352',
 'bolwarrah-vic-3352',
 'bonshaw-vic-3352',
 'brewster-vic-3352',
 'bullarook-vic-3352',
 'bungaree-vic-3352',
 'bunkers-hill-vic-3352',
 'burrumbeet-vic-3352',
 'cambrian-hill-vic-3352',
 'cardigan-vic-3352',
 'cardigan-village-vic-3352',
 'chapel-flat-vic-3352',
 'clarendon-vic-3352',
 'claretown-vic-3352',
 'clarkes-hill-vic-3352',
 'corindhap-vic-3352',
 'dereel-vic-3352',
 'dunnstown-vic-3352',
 'durham-lead-vic-3352',
 'enfield-vic-3352',
 'ercildoune-vic-3352',
 'garibaldi-vic-3352',
 'glen-park-vic-3352',
 'glenbrae-vic-3352'
 ]

N_PAGES = range(1, 25)  
OUTPUT_FILE = 'data/landing/rental_scrape.csv'


def fetch_property_links(pages, suburbs):
    """
    Fetches URLs of property listings from a specified number of pages.

    Parameters:
    pages: a range of pages to scrape for property links.
    suburbs: list of suburbs to search for property listings.

    Returns:
    list: A list of URLs pointing to individual property listings.
    """
    print("Starting to fetch property links...")
    url_links = []
    
    for suburb in suburbs:
        for page in pages:
            url = BASE_URL + f"/rent/{suburb}/?page={page}"
            print(f"Visiting {url}")
            
            try:
                print("Sending request to server...")
                bs_object = BeautifulSoup(urlopen(Request(url, headers={'User-Agent': "PostmanRuntime/7.6.0"}), timeout=100), "lxml")
                print("Successfully received response.")
                
                index_links = bs_object.find("ul", {"data-testid": "results"}).findAll(
                    "a", href=re.compile(f"{BASE_URL}/*")
                )
                
                for link in index_links:
                    if 'address' in link.get('class', []):
                        url_links.append(link['href'])
                        print(f"Found link: {link['href']}")

            except HTTPError as e:
                print(f"HTTP Error: {e.code} - {e.reason} for {url}. Moving to the next suburb.")
                continue
            except URLError as e:
                print(f"URL Error: {e.reason} for {url}. Moving to the next suburb.")
                continue
            except Exception as e:
                print(f"Error fetching {url}: {e}. Moving to the next suburb.")
                continue
            
            # Add random delay between requests
            delay = random.uniform(1, 2)
            print(f"Delaying for {delay:.2f} seconds...")
            time.sleep(delay)
    
    print("Finished fetching property links.")
    return url_links

def get_unique_urls(url_list):
    """
    Filters out duplicate URLs from the list.

    Parameters:
    url_list: A list of URLs.

    Returns:
    list: A list of unique URLs.
    """
    url_list = list(set(url_list))
    print(f"Filtered unique URLs. Original count: {len(url_list)}, Unique count: {len(url_list)}")
    return url_list

def scrape_property_data(url_links):
    """
    Scrapes basic metadata from each property listing page.

    Parameters:
    url_links: a list of URLs pointing to individual property listings.

    Returns:
    defaultdict: a dictionary containing scraped metadata for each property.
    """
    print("Starting to scrape property data...")
    all_properties = []
    success_count, total_count = 0, 0
    pbar = tqdm(url_links)
    for property_url in pbar:
        retry_count = 0
        max_retries = 3
        backoff_time = 1  
    
        while retry_count < max_retries:
            print(f"Scraping {property_url} (Attempt {retry_count + 1}/{max_retries})")
            try:
                bs_object = BeautifulSoup(urlopen(Request(property_url, headers={'User-Agent': "PostmanRuntime/7.6.0"}), timeout=303), "lxml")
                total_count += 1

                # Extract property details
                address = bs_object.find("h1", {"class": "css-164r41r"}).text if bs_object.find("h1", {"class": "css-164r41r"}) else 'N/A'
                cost_text = bs_object.find("div", {"data-testid": "listing-details__summary-title"}).text if bs_object.find("div", {"data-testid": "listing-details__summary-title"}) else 'N/A'
                rooms = bs_object.find("div", {"data-testid": "property-features"}).findAll("span", {"data-testid": "property-features-text-container"})
                bed_info = [re.findall(r'\d+\s[A-Za-z]+', feature.text)[0] for feature in rooms if 'Bed' in feature.text]
                bath_info = [re.findall(r'\d+\s[A-Za-z]+', feature.text)[0] for feature in rooms if 'Bath' in feature.text]
                parking_info = [re.findall(r'\S+\s[A-Za-z]+', feature.text)[0] for feature in rooms if 'Parking' in feature.text]
                desc_element = bs_object.find("p")
                desc = re.sub(r'<br\/>', '\n', str(desc_element)).strip('</p>') if desc_element else 'N/A'
                property_type_element = bs_object.find("div", {"data-testid":"listing-summary-property-type"})
                property_type = property_type_element.find("span").text.strip() if property_type_element else 'N/A'

                # Collect data
                # Collect data
                all_properties.append({
                    'URL': property_url,
                    'Address': address,
                    'Cost': cost_text,
                    'Bedrooms': ', '.join(bed_info),
                    'Bathrooms': ', '.join(bath_info),
                    'Parking': ', '.join(parking_info),
                    'Description': desc,
                    'Address': address,
                    'PropertyType': property_type
                })

                print(f"Successfully scraped data for {property_url}")
                success_count += 1
                break   
            except Exception as e:
                print(f"Issue with {property_url}: {e}")
                retry_count += 1
                if retry_count < max_retries:
                    print(f"Retrying in {backoff_time} seconds...")
                    time.sleep(backoff_time)  
                    backoff_time *= 2  # backing off on retry
                else:
                    print(f"Failed to scrape {property_url} after {max_retries} attempts.")
                    
        pbar.set_description(f"{(success_count/total_count * 100):.0f}% successful")
    
    print("Finished scraping property data.")
    return all_properties


def save_data(data, output_file):
    """
    Saves scraped property metadata to a CSV file.

    Parameters:
    data: list of dictionaries containing property metadata to save.
    output_file: the path where the CSV file will be saved.
    """
    try:
        print(f"Saving data to {output_file}...")
        os.makedirs(os.path.dirname(output_file), exist_ok=True)
        
        # Define CSV headers
        headers = ['URL', 'Name', 'Cost', 'Bedrooms', 'Bathrooms', 'Parking', 'Description', 'Address', 'PropertyType']

        with open(output_file, 'w', newline='', encoding='utf-8') as f:
            writer = csv.DictWriter(f, fieldnames=headers)
            writer.writeheader()
            writer.writerows(data)

        print(f"Data successfully saved to {output_file}.")
    
    except Exception as e:
        print(f"An error occurred while saving data: {e}")

# main execution
if __name__ == "__main__":
    links = fetch_property_links(N_PAGES, SUBURBS)
    links = get_unique_urls(links)
    metadata = scrape_property_data(links)
    save_data(metadata, OUTPUT_FILE)


